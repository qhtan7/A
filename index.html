<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“± Ø¶Ø§ØºØ· PDF Ø§Ù„ÙØ¹Ù„ÙŠ - Ù‚Ø­Ø·Ø§Ù† Ø§Ù„Ø³Ù„Ø·Ø§Ù†</title>
    
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    
    <script>
        // Ø¶Ø¨Ø· Ø¹Ø§Ù…Ù„ Worker Ù„Ù…ÙƒØªØ¨Ø© PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
    </script>

    <style>
        /* Ù†ÙØ³ Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø³Ø§Ø¨Ù‚ ØªÙ…Ø§Ù…Ø§Ù‹ */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        :root { --primary: #4361ee; --primary-dark: #3a0ca3; --success: #4CAF50; --warning: #FF9800; --danger: #F44336; --light: #f8f9fa; --dark: #212529; }
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 15px; }
        .container { background: white; border-radius: 20px; padding: 20px; max-width: 100%; margin: 0 auto; box-shadow: 0 20px 40px rgba(0,0,0,0.3); }
        .header { text-align: center; padding: 20px 0; border-bottom: 2px solid #eee; margin-bottom: 20px; }
        .logo { font-size: 50px; color: var(--primary); margin-bottom: 10px; animation: bounce 2s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .title { color: var(--primary); font-size: 24px; font-weight: bold; margin-bottom: 5px; }
        .badge { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 8px 20px; border-radius: 30px; font-weight: bold; display: inline-block; font-size: 12px; margin-top: 10px; }
        .upload-area { border: 3px dashed #ddd; border-radius: 15px; padding: 40px 20px; text-align: center; margin: 20px 0; background: #f8f9ff; cursor: pointer; transition: all 0.3s; }
        .upload-area:hover { border-color: var(--primary); background: rgba(67, 97, 238, 0.05); }
        .upload-icon { font-size: 50px; color: var(--primary); margin-bottom: 15px; }
        .file-info { background: #e8f5e9; padding: 15px; border-radius: 10px; margin: 15px 0; display: none; }
        .compression-options { background: white; border-radius: 15px; padding: 20px; margin: 20px 0; border: 2px solid #f0f0f0; }
        .options-title { color: var(--primary); font-size: 20px; margin-bottom: 20px; text-align: center; }
        .option-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .option-card { background: #f8f9ff; border-radius: 10px; padding: 15px; text-align: center; border: 2px solid #e0e0e0; cursor: pointer; transition: all 0.3s; }
        .option-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .option-card.selected { border-color: var(--primary); background: rgba(67, 97, 238, 0.1); }
        .option-icon { font-size: 30px; margin-bottom: 10px; }
        .option-name { font-weight: bold; margin-bottom: 5px; color: var(--dark); }
        .option-desc { font-size: 12px; color: #666; }
        .progress-container { background: white; border-radius: 15px; padding: 20px; margin: 20px 0; display: none; }
        .progress-bar { width: 100%; height: 20px; background: #f0f0f0; border-radius: 10px; overflow: hidden; margin-bottom: 10px; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--primary), #4cc9f0); width: 0%; transition: width 0.3s; border-radius: 10px; }
        .progress-text { text-align: center; font-weight: bold; color: var(--primary); }
        .results { background: #f0f7ff; border-radius: 15px; padding: 20px; margin: 20px 0; border: 2px solid var(--primary); display: none; }
        .results-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin: 20px 0; }
        .result-card { background: white; padding: 15px; border-radius: 10px; text-align: center; box-shadow: 0 3px 10px rgba(0,0,0,0.1); }
        .result-label { color: #666; font-size: 14px; margin-bottom: 5px; }
        .result-value { font-size: 20px; font-weight: bold; color: var(--primary); }
        .saving-badge { background: linear-gradient(135deg, var(--success), #2E7D32); color: white; padding: 10px 20px; border-radius: 30px; font-weight: bold; text-align: center; margin: 20px auto; display: inline-block; }
        .btn { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; border: none; padding: 15px 30px; border-radius: 50px; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.3s; display: inline-flex; align-items: center; justify-content: center; gap: 10px; width: 100%; margin: 10px 0; }
        .btn:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(67, 97, 238, 0.3); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-success { background: linear-gradient(135deg, var(--success), #2E7D32); }
        .btn-danger { background: linear-gradient(135deg, var(--danger), #C62828); }
        .message { padding: 15px; border-radius: 10px; margin: 10px 0; font-weight: bold; text-align: center; display: none; }
        .message.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .message.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .message.info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .footer { text-align: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; color: #666; font-size: 12px; }
        @media (max-width: 480px) { .container { padding: 15px; } .option-grid { grid-template-columns: 1fr; } .results-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <div id="message" class="message"></div>
        
        <div class="header">
            <div class="logo">ğŸ“„âœ¨</div>
            <h1 class="title">Ø¶Ø§ØºØ· PDF Ø§Ù„ÙØ¹Ù„ÙŠ</h1>
            <p>ÙŠØ¶ØºØ· Ø§Ù„Ù…Ù„ÙØ§Øª ÙØ¹Ù„ÙŠØ§Ù‹ ÙˆÙŠÙ‚Ù„Ù„ Ø§Ù„Ø­Ø¬Ù… Ø¨Ù†Ø³Ø¨Ø© ØªØµÙ„ Ø¥Ù„Ù‰ 95%</p>
            <div class="badge">Ø¨Ø±Ù…Ø¬Ø©: Ù‚Ø­Ø·Ø§Ù† Ø§Ù„Ø³Ù„Ø·Ø§Ù† - Ø§Ù„Ø¥ØµØ¯Ø§Ø± 2.0 (Ø§Ù„Ù…Ø­Ø±Ùƒ Ø§Ù„ÙØ¹Ù„ÙŠ)</div>
        </div>
        
        <div id="fileInfo" class="file-info">
            <div id="fileName"></div>
            <div id="fileSize"></div>
        </div>
        
        <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
            <input type="file" id="fileInput" accept=".pdf" hidden 
                   onchange="handleFileSelect(event)">
            <div class="upload-icon">ğŸ“¤</div>
            <h3>Ø§Ù†Ù‚Ø± Ù„Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù PDF</h3>
            <p>Ø£Ùˆ Ø§Ø³Ø­Ø¨ Ø§Ù„Ù…Ù„Ù ÙˆØ£ÙÙ„ØªÙ‡ Ù‡Ù†Ø§</p>
            <p style="color: #666; font-size: 14px; margin-top: 10px;">
                Ø§Ù„Ø¶ØºØ· ÙŠØªÙ… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ø¹Ù„Ù‰ Ù…ØªØµÙØ­Ùƒ
            </p>
        </div>
        
        <div class="compression-options">
            <h3 class="options-title">âš¡ Ø§Ø®ØªØ± Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø¶ØºØ·</h3>
            
            <div class="option-grid">
                <div class="option-card" onclick="selectOption('good')" id="optionGood">
                    <div class="option-icon">ğŸ‘</div>
                    <div class="option-name">Ø¬ÙˆØ¯Ø© Ø¹Ø§Ù„ÙŠØ©</div>
                    <div class="option-desc">Ø¯Ù‚Ø© Ø¹Ø§Ù„ÙŠØ©<br>Ø­Ø¬Ù… Ù…ØªÙˆØ³Ø·</div>
                </div>
                
                <div class="option-card selected" onclick="selectOption('balanced')" id="optionBalanced">
                    <div class="option-icon">âš–ï¸</div>
                    <div class="option-name">Ù…ØªÙˆØ§Ø²Ù†</div>
                    <div class="option-desc">ØªÙˆÙÙŠØ± Ø¬ÙŠØ¯<br>Ù‚Ø±Ø§Ø¡Ø© ÙˆØ§Ø¶Ø­Ø©</div>
                </div>
                
                <div class="option-card" onclick="selectOption('strong')" id="optionStrong">
                    <div class="option-icon">ğŸ’ª</div>
                    <div class="option-name">Ù‚ÙˆÙŠ</div>
                    <div class="option-desc">ØªÙˆÙÙŠØ± ÙƒØ¨ÙŠØ±<br>Ø¬ÙˆØ¯Ø© Ù…Ù‚Ø¨ÙˆÙ„Ø©</div>
                </div>
                
                <div class="option-card" onclick="selectOption('extreme')" id="optionExtreme">
                    <div class="option-icon">ğŸ”¥</div>
                    <div class="option-name">Ø£Ù‚ØµÙ‰ Ø¶ØºØ·</div>
                    <div class="option-desc">Ø£ØµØºØ± Ø­Ø¬Ù…<br>Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø³Ø±ÙŠØ¹Ø©</div>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 15px;">
                <label style="color: #666; font-size: 14px;">
                    <input type="checkbox" id="grayscale" style="margin-left: 5px;">
                    ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ ØªØ¯Ø±Ø¬ Ø§Ù„Ø±Ù…Ø§Ø¯ÙŠ (ÙŠÙ‚Ù„Ù„ Ø§Ù„Ø­Ø¬Ù… Ø£ÙƒØ«Ø±)
                </label>
            </div>
        </div>
        
        <div class="progress-container" id="progressContainer">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">0%</div>
        </div>
        
        <div class="results" id="resultsSection">
            <h3 style="text-align: center; color: var(--primary); margin-bottom: 20px;">
                ğŸ‰ ØªÙ… Ø§Ù„Ø¶ØºØ· Ø§Ù„ÙØ¹Ù„ÙŠ Ø¨Ù†Ø¬Ø§Ø­!
            </h3>
            
            <div class="results-grid">
                <div class="result-card">
                    <div class="result-label">Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ø£ØµÙ„ÙŠ</div>
                    <div class="result-value" id="originalSizeResult">0 MB</div>
                </div>
                
                <div class="result-card">
                    <div class="result-label">Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯</div>
                    <div class="result-value" id="compressedSizeResult">0 MB</div>
                </div>
                
                <div class="result-card">
                    <div class="result-label">Ù†Ø³Ø¨Ø© Ø§Ù„ØªÙˆÙÙŠØ±</div>
                    <div class="result-value" id="savingPercent">0%</div>
                </div>
                
                <div class="result-card">
                    <div class="result-label">Ø§Ù„ÙˆÙ‚Øª</div>
                    <div class="result-value" id="processingTime">0 Ø«</div>
                </div>
            </div>
            
            <div style="text-align: center;">
                <div class="saving-badge" id="savingBadge">ÙˆÙØ±Øª 0%</div>
            </div>
            
            <button class="btn btn-success" onclick="downloadFile()" id="downloadBtn">
                â¬‡ï¸ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø¶ØºÙˆØ·
            </button>
        </div>
        
        <button class="btn" id="compressBtn" onclick="startRealCompression()" disabled>
            ğŸš€ Ø¨Ø¯Ø¡ Ø¶ØºØ· PDF
        </button>
        
        <button class="btn btn-danger" onclick="resetApp()">
            ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„ ÙˆØ¨Ø¯Ø¡ Ø¬Ø¯ÙŠØ¯
        </button>
        
        <div class="compression-options" style="margin-top: 20px;">
            <h3 style="color: var(--primary); margin-bottom: 15px;">â„¹ï¸ ÙƒÙŠÙ ÙŠØ¹Ù…Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù…Ø·ÙˆØ±ØŸ</h3>
            <div style="color: #666; line-height: 1.6;">
                <p>âœ… ÙŠÙ‚ÙˆÙ… Ø¨ØªØ­ÙˆÙŠÙ„ ØµÙØ­Ø§Øª PDF Ø¥Ù„Ù‰ ØµÙˆØ± Ø¹Ø§Ù„ÙŠØ© Ø§Ù„ÙƒÙØ§Ø¡Ø©.</p>
                <p>âœ… ÙŠØ¹ÙŠØ¯ ØªØ´ÙƒÙŠÙ„ Ø§Ù„ØµÙˆØ± Ø¨Ø¯Ù‚Ø© (DPI) ÙˆØ¬ÙˆØ¯Ø© (JPEG Quality) Ø£Ù‚Ù„ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ø®ØªÙŠØ§Ø±Ùƒ.</p>
                <p>âœ… ÙŠÙ‚ÙˆÙ… Ø¨Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®ÙÙŠØ© ÙˆØ§Ù„Ø®Ø·ÙˆØ· ØºÙŠØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©.</p>
                <p>âš ï¸ <strong>Ù…Ù„Ø§Ø­Ø¸Ø©:</strong> Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù†Ø§ØªØ¬ Ù„Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ù†Øµ ÙÙŠÙ‡ Ù‚Ø§Ø¨Ù„Ø§Ù‹ Ù„Ù„Ù†Ø³Ø® (ÙŠØªØ­ÙˆÙ„ Ù„ØµÙˆØ±) Ù„Ø¶Ù…Ø§Ù† Ø£Ù‚ØµÙ‰ Ø¶ØºØ·.</p>
            </div>
        </div>
        
        <div class="footer">
            <p>Â© 2024 ØªØ·Ø¨ÙŠÙ‚ Ø¶ØºØ· PDF Ø§Ù„ÙØ¹Ù„ÙŠ - Ø¨Ø±Ù…Ø¬Ø© Ù‚Ø­Ø·Ø§Ù† Ø§Ù„Ø³Ù„Ø·Ø§Ù†</p>
            <p>ÙŠØ¹Ù…Ù„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ØªÙ‚Ù†ÙŠØ§Øª PDF.js Ùˆ PDF-Lib</p>
        </div>
    </div>

    <script>
        // ============================================
        // ØªØ·Ø¨ÙŠÙ‚ Ø¶ØºØ· PDF Ø§Ù„ÙØ¹Ù„ÙŠ (Ù…Ø­Ø±Ùƒ Ø­Ù‚ÙŠÙ‚ÙŠ)
        // Ø¨Ø±Ù…Ø¬Ø©: Ù‚Ø­Ø·Ø§Ù† Ø§Ù„Ø³Ù„Ø·Ø§Ù†
        // ============================================
        
        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¶ØºØ· Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
        let compressionSettings = {
            level: 'balanced',
            scale: 1.0,  // Ø¹Ø§Ù…Ù„ ØªØµØºÙŠØ± Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯
            quality: 0.6 // Ø¬ÙˆØ¯Ø© Ø§Ù„ØµÙˆØ±Ø© (0 Ø¥Ù„Ù‰ 1)
        };
        
        let selectedFile = null;
        let originalSize = 0;
        let compressedBlob = null;
        let startTime = 0;
        
        document.addEventListener('DOMContentLoaded', function() {
            showMessage('Ù…Ø±Ø­Ø¨Ø§Ù‹! Ù‡Ø°Ø§ Ø§Ù„Ø¥ØµØ¯Ø§Ø± ÙŠÙ‚ÙˆÙ… Ø¨Ø¶ØºØ· ÙØ¹Ù„ÙŠ Ù„Ù„Ù…Ù„ÙØ§Øª.', 'info');
            setupDragAndDrop();
        });
        
        function setupDragAndDrop() {
            const uploadArea = document.getElementById('uploadArea');
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = 'var(--primary)';
                uploadArea.style.background = 'rgba(67, 97, 238, 0.05)';
            });
            uploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#ddd';
                uploadArea.style.background = '#f8f9ff';
            });
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#ddd';
                uploadArea.style.background = '#f8f9ff';
                if (e.dataTransfer.files.length) handleFileSelect({ target: { files: e.dataTransfer.files } });
            });
        }

        // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„Ø¶ØºØ· Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©
        function selectOption(level) {
            compressionSettings.level = level;
            
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø³Ø§Ø¨Ù‚
            document.querySelectorAll('.option-card').forEach(card => card.classList.remove('selected'));
            document.getElementById('option' + level.charAt(0).toUpperCase() + level.slice(1)).classList.add('selected');
            
            // Ø¶Ø¨Ø· Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¦ÙŠØ© Ù„Ù„Ø¶ØºØ·
            switch(level) {
                case 'good':
                    compressionSettings.scale = 1.2; // Ø¯Ù‚Ø© Ø¹Ø§Ù„ÙŠØ©
                    compressionSettings.quality = 0.8; // Ø¬ÙˆØ¯Ø© ØµÙˆØ± Ø¹Ø§Ù„ÙŠØ©
                    break;
                case 'balanced':
                    compressionSettings.scale = 0.9; // Ø¯Ù‚Ø© Ù…ØªÙˆØ³Ø·Ø©
                    compressionSettings.quality = 0.6; // Ø¬ÙˆØ¯Ø© Ù…ØªÙˆØ³Ø·Ø©
                    break;
                case 'strong':
                    compressionSettings.scale = 0.7; // ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯
                    compressionSettings.quality = 0.4; // Ø¶ØºØ· JPEG Ù‚ÙˆÙŠ
                    break;
                case 'extreme':
                    compressionSettings.scale = 0.5; // Ù†ØµÙ Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯
                    compressionSettings.quality = 0.2; // Ø£Ù‚ØµÙ‰ Ø¶ØºØ·
                    break;
            }
        }
        
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.name.toLowerCase().endsWith('.pdf')) {
                showMessage('âŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù PDF ÙÙ‚Ø·', 'error');
                return;
            }
            
            selectedFile = file;
            originalSize = file.size;
            
            document.getElementById('fileInfo').style.display = 'block';
            document.getElementById('fileName').textContent = `Ø§Ù„Ù…Ù„Ù: ${file.name}`;
            document.getElementById('fileSize').textContent = `Ø§Ù„Ø­Ø¬Ù…: ${(file.size / (1024 * 1024)).toFixed(2)} MB`;
            document.getElementById('compressBtn').disabled = false;
            document.getElementById('resultsSection').style.display = 'none';
            
            showMessage('âœ… Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¶ØºØ· Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ!', 'success');
        }

        // ==========================================
        // Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© Ø§Ù„Ø¶ØºØ· Ø§Ù„ÙØ¹Ù„ÙŠØ©
        // ==========================================
        async function startRealCompression() {
            if (!selectedFile) return;
            
            startTime = Date.now();
            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('compressBtn').disabled = true;
            document.getElementById('resultsSection').style.display = 'none';
            
            try {
                updateProgress(5, 'Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ù…Ù„Ù PDF...');
                
                // 1. Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù ÙƒÙ…ØµÙÙˆÙØ© Ø¨ÙŠØ§Ù†Ø§Øª
                const arrayBuffer = await selectedFile.arrayBuffer();
                
                // 2. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… PDF.js
                const pdfDoc = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                const totalPages = pdfDoc.numPages;
                
                // 3. Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªÙ†Ø¯ PDF Ø¬Ø¯ÙŠØ¯ ÙØ§Ø±Øº
                const newPdfDoc = await PDFLib.PDFDocument.create();
                
                const isGrayscale = document.getElementById('grayscale').checked;
                
                // 4. Ø­Ù„Ù‚Ø© ØªÙƒØ±Ø§Ø±ÙŠØ© Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© ÙƒÙ„ ØµÙØ­Ø©
                for (let i = 1; i <= totalPages; i++) {
                    const percent = 10 + Math.round(((i - 1) / totalPages) * 80);
                    updateProgress(percent, `Ø¬Ø§Ø±ÙŠ Ø¶ØºØ· Ø§Ù„ØµÙØ­Ø© ${i} Ù…Ù† ${totalPages}...`);
                    
                    // Ø¬Ù„Ø¨ Ø§Ù„ØµÙØ­Ø©
                    const page = await pdfDoc.getPage(i);
                    
                    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¶ØºØ·
                    // Ù†Ø³ØªØ®Ø¯Ù… viewport Ø£ØµÙ„ÙŠ Ø«Ù… Ù†Ù‚ÙˆÙ… Ø¨ØªØ­Ø¬ÙŠÙ…Ù‡ ÙÙŠ Canvas Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠÙƒØ³Ù„Ø§Øª
                    const originalViewport = page.getViewport({ scale: 1.0 });
                    
                    // Ø­Ø³Ø§Ø¨ Ù…Ø¹Ø§Ù…Ù„ Ø§Ù„ØªØ­Ø¬ÙŠÙ… Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (Ù…Ø«Ù„Ø§Ù‹ 0.5 Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø­Ø¬Ù… Ù„Ù„Ù†ØµÙ)
                    const outputScale = compressionSettings.scale; 
                    
                    const viewport = page.getViewport({ scale: outputScale });
                    
                    // Ø¥Ù†Ø´Ø§Ø¡ Canvas Ù„Ù„Ø±Ø³Ù…
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    
                    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØµÙŠÙŠØ± (Rendering)
                    const renderContext = {
                        canvasContext: context,
                        viewport: viewport
                    };
                    
                    // ØªØ­ÙˆÙŠÙ„ PDF -> Canvas
                    await page.render(renderContext).promise;
                    
                    // ØªØ­ÙˆÙŠÙ„ Canvas -> ØµÙˆØ±Ø© Ù…Ø¶ØºÙˆØ·Ø© (JPEG)
                    // Ù‡Ù†Ø§ ÙŠØ­Ø¯Ø« Ø§Ù„Ø³Ø­Ø±: Ù†ØªØ­ÙƒÙ… ÙÙŠ quality Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø­Ø¬Ù…
                    let imgDataUrl = canvas.toDataURL('image/jpeg', compressionSettings.quality);
                    
                    // ØªØ¶Ù…ÙŠÙ† Ø§Ù„ØµÙˆØ±Ø© ÙÙŠ Ù…Ù„Ù PDF Ø§Ù„Ø¬Ø¯ÙŠØ¯
                    const jpgImage = await newPdfDoc.embedJpg(imgDataUrl);
                    
                    // Ø¥Ø¶Ø§ÙØ© ØµÙØ­Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø¶ØºÙˆØ· Ø¨Ù†ÙØ³ Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„ØµÙˆØ±Ø©
                    const newPage = newPdfDoc.addPage([viewport.width, viewport.height]);
                    
                    // Ø±Ø³Ù… Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø¶ØºÙˆØ·Ø© Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø©
                    newPage.drawImage(jpgImage, {
                        x: 0,
                        y: 0,
                        width: viewport.width,
                        height: viewport.height,
                    });
                    
                    // ØªØ­Ø±ÙŠØ± Ø§Ù„Ø°Ø§ÙƒØ±Ø©
                    canvas.remove();
                }
                
                updateProgress(95, 'Ø¬Ø§Ø±ÙŠ ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ...');
                
                // Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯
                const pdfBytes = await newPdfDoc.save();
                compressedBlob = new Blob([pdfBytes], { type: 'application/pdf' });
                
                updateProgress(100, 'ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ©!');
                
                showResults(compressedBlob.size);
                
            } catch (error) {
                console.error(error);
                showMessage('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©: ' + error.message, 'error');
                document.getElementById('progressContainer').style.display = 'none';
                document.getElementById('compressBtn').disabled = false;
            }
        }
        
        function updateProgress(percent, text) {
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressText').textContent = text;
        }
        
        function showResults(newSize) {
            document.getElementById('progressContainer').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'block';
            
            const originalSizeMB = (originalSize / (1024 * 1024)).toFixed(2);
            const compressedSizeMB = (newSize / (1024 * 1024)).toFixed(2);
            const savingPercent = ((originalSize - newSize) / originalSize * 100).toFixed(1);
            const timeTaken = ((Date.now() - startTime) / 1000).toFixed(1);
            
            document.getElementById('originalSizeResult').textContent = originalSizeMB + ' MB';
            document.getElementById('compressedSizeResult').textContent = compressedSizeMB + ' MB';
            document.getElementById('savingPercent').textContent = savingPercent + '%';
            document.getElementById('processingTime').textContent = timeTaken + ' Ø«';
            document.getElementById('savingBadge').textContent = `ÙˆÙØ±Øª ${savingPercent}%`;
            
            // ØªØºÙŠÙŠØ± Ù„ÙˆÙ† Ø§Ù„Ø´Ø§Ø±Ø© Ø­Ø³Ø¨ Ø§Ù„Ù†ØªÙŠØ¬Ø©
            const badge = document.getElementById('savingBadge');
            if (savingPercent > 0) {
                 badge.style.background = 'linear-gradient(135deg, var(--success), #2E7D32)';
                 showMessage(`âœ… Ù…Ø°Ù‡Ù„! ØªÙ… ØªÙ‚Ù„ÙŠÙ„ Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­.`, 'success');
            } else {
                 badge.style.background = 'linear-gradient(135deg, var(--warning), #F57C00)';
                 badge.textContent = 'Ø²Ø§Ø¯ Ø§Ù„Ø­Ø¬Ù… (Ø¬Ø±Ø¨ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Ù‹ Ø£Ù‚Ù„)';
                 showMessage(`âš ï¸ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù†Ø§ØªØ¬ Ø£ÙƒØ¨Ø±ØŒ Ø¬Ø±Ø¨ Ø§Ø®ØªÙŠØ§Ø± "Ø£Ù‚ØµÙ‰ Ø¶ØºØ·"`, 'info');
            }
            
            document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
        }
        
        function downloadFile() {
            if (!compressedBlob) return;
            const url = URL.createObjectURL(compressedBlob);
            const a = document.createElement('a');
            const originalName = selectedFile.name.replace('.pdf', '');
            a.href = url;
            a.download = `${originalName}_Ù…Ø¶ØºÙˆØ·_${compressionSettings.level}.pdf`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        function resetApp() {
            selectedFile = null;
            originalSize = 0;
            compressedBlob = null;
            document.getElementById('fileInfo').style.display = 'none';
            document.getElementById('fileInput').value = '';
            document.getElementById('compressBtn').disabled = true;
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('progressContainer').style.display = 'none';
            selectOption('balanced');
            document.getElementById('grayscale').checked = false;
        }
        
        function showMessage(text, type) {
            const msg = document.getElementById('message');
            msg.textContent = text;
            msg.className = `message ${type}`;
            msg.style.display = 'block';
            setTimeout(() => msg.style.display = 'none', 5000);
        }
    </script>
</body>
</html>
